<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiseQuy - QR Code Generator</title>
    <style>
        .qr-item {
            margin: 10px 0;
            border: 1px solid #ccc;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .qr-item canvas {
            margin-bottom: 10px;
            width: 150px;
            height: 150px;
        }

        .qr-item p {
            margin: 5px 0;
            font-size: 14px;
        }

        .qr-list {
            margin-top: 20px;
        }

        .printable {
            display: block !important;
            visibility: visible !important;
            position: relative !important;
            margin-top: 20px;
            page-break-before: auto;
        }

        .printable .print-item {
            display: inline-block;
            width: 30%;
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dotted #000;
            box-sizing: border-box;
            vertical-align: top;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .printable .print-item img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .printable .print-item p {
            margin: 5px 0;
            text-align: center;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .printable, .printable * {
                visibility: visible;
            }
            .printable {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .printable .print-item {
                border-bottom: 1px dotted #000;
            }

            .printable .print-item:nth-child(3n) {
                border-right: none;
            }
        }

        button[disabled] {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>WiseQuy - QR Code Generator</h1>
    <button id="generateBtn">Generate QR Code</button>
    <div class="qr-list" id="qrList"></div>
    <p id="limitMessage" style="color: red; display: none;">Limit reached: You can generate up to 6 QR codes.</p>
    <button id="printBtn">Print All QR Codes</button>

    <div class="printable" id="printableContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
        const maxQRCodes = 6;
        let qrCodes = [];
        const usedColors = new Set();
        const usedTrees = new Set();

        document.getElementById("generateBtn").addEventListener("click", function() {
            if (qrCodes.length >= maxQRCodes) {
                return;
            }

            console.log(`Generating QR code number ${qrCodes.length + 1}`);

            const uniqueId = generateUniqueId();
            const colors = generateUniqueColors();
            const trees = generateUniqueTrees();

            const qrData = {
                id: uniqueId,
                colors: colors,
                trees: trees
            };

            const qrString = encodeURIComponent(JSON.stringify(qrData));
            const targetUrl = `https://dormantone.github.io/wisequy/clipboard.html?data=${qrString}`;

            generateQRCode(targetUrl, qrData);

            if (qrCodes.length + 1 >= maxQRCodes) {
                console.log("Max QR codes limit reached, disabling generate button.");
                disableGenerateButton();
            }
        });

        function generateUniqueId() {
            const timestamp = Date.now().toString(36);
            const randomPart = Math.random().toString(36).substring(2, 8);
            return `${timestamp}${randomPart}`.toUpperCase();
        }

        function generateUniqueColors() {
            const colors = ["red", "green", "blue", "yellow", "purple", "orange", "pink", "brown", "black", "white", 
                            "gray", "cyan", "magenta", "lime", "maroon", "navy", "olive", "teal", "silver", "gold"];

            const selectedColors = [];
            while (selectedColors.length < 3) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                if (!usedColors.has(color)) {
                    selectedColors.push(color);
                    usedColors.add(color);
                }
            }
            console.log("Selected colors:", selectedColors);
            return selectedColors;
        }

        function generateUniqueTrees() {
            const trees = ["oak", "pine", "maple", "birch", "willow", "cedar", "spruce", "fir", "ash", "elm", 
                           "cherry", "apple", "peach", "pear", "plum", "walnut", "hickory", "cypress", "juniper", "sycamore"];

            const selectedTrees = [];
            while (selectedTrees.length < 3) {
                const tree = trees[Math.floor(Math.random() * trees.length)];
                if (!usedTrees.has(tree)) {
                    selectedTrees.push(tree);
                    usedTrees.add(tree);
                }
            }
            console.log("Selected trees:", selectedTrees);
            return selectedTrees;
        }

        function generateQRCode(url, qrData) {
            const qrCodeContainer = document.createElement("div");
            qrCodeContainer.classList.add("qr-item");

            const qrCanvas = document.createElement("canvas");
            qrCodeContainer.appendChild(qrCanvas);

            QRCode.toCanvas(qrCanvas, url, { width: 150, height: 150 }, function (error) {
                if (error) {
                    console.error("Error generating QR code:", error);
                } else {
                    console.log("QR code generated successfully.");
                    qrCodes.push({ qrData, qrCanvas });
                    renderPrintable();
                }
            });

            const qrInfoColors = document.createElement("p");
            qrInfoColors.textContent = `Colors: ${qrData.colors.join(", ")}`;
            qrCodeContainer.appendChild(qrInfoColors);

            const qrInfoTrees = document.createElement("p");
            qrInfoTrees.textContent = `Trees: ${qrData.trees.join(", ")}`;
            qrCodeContainer.appendChild(qrInfoTrees);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.addEventListener("click", function() {
                qrCodes = qrCodes.filter(item => item.qrData.id !== qrData.id);
                usedColors.delete(...qrData.colors);
                usedTrees.delete(...qrData.trees);
                console.log(`Deleted QR code. ${qrCodes.length} remaining.`);
                enableGenerateButton();
                renderPrintable();
            });
            qrCodeContainer.appendChild(deleteBtn);

            document.getElementById("qrList").appendChild(qrCodeContainer);

            console.log(`QR code ${qrData.id} added. Total: ${qrCodes.length}`);
        }

        function renderPrintable() {
            const printableContainer = document.getElementById("printableContainer");
            printableContainer.innerHTML = ""; // Clear the existing content

            qrCodes.forEach(({ qrData, qrCanvas }) => {
                const printItem = document.createElement("div");
                printItem.classList.add("print-item");

                // Convert canvas to image
                const image = new Image();
                image.src = qrCanvas.toDataURL("image/png");
                image.style.display = "block";
                image.style.margin = "0 auto";
                printItem.appendChild(image);

                const printInfoColors = document.createElement("p");
                printInfoColors.textContent = `Colors: ${qrData.colors.join(", ")}`;
                printItem.appendChild(printInfoColors);

                const printInfoTrees = document.createElement("p");
                printInfoTrees.textContent = `Trees: ${qrData.trees.join(", ")}`;
                printItem.appendChild(printInfoTrees);

                printableContainer.appendChild(printItem);
            });

            console.log(`Rendered printable area. Container height: ${printableContainer.scrollHeight}px`);
        }

        function disableGenerateButton() {
            const generateBtn = document.getElementById("generateBtn");
            generateBtn.disabled = true;
            generateBtn.textContent = "Limit reached (6 QR codes)";
            document.getElementById("limitMessage").style.display = "block";
        }

        function enableGenerateButton() {
            if (qrCodes.length < maxQRCodes) {
                const generateBtn = document.getElementById("generateBtn");
                generateBtn.disabled = false;
                generateBtn.textContent = "Generate QR Code";
                document.getElementById("limitMessage").style.display = "none";
            }
        }

        document.getElementById("printBtn").addEventListener("click", function() {
            console.log("Print button clicked. Preparing to print...");
            window.print();
        });
    </script>
</body>
</html>
